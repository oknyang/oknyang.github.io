---
title: "중복실행방지 기능 lock 위치 다변화"
date: "2020-05-26"
---

## 중복실행 방지 lock 기록 위치 다변화
이전까지는 couchbase cache 버킷에 lock을 기록했으나, couchbase 장애 발생으로 해당 기능에까지 영향을 받게 되어 lock 위치를 다변화하여 사용중인 저장소 오류 발생시 다른 저장소로 쉽게 교체할 수 있도록 개선함.  

Memcached lock 저장소 추가.
```java
@Component
public class MemcachedLockingManager implements LockingManager<String> {
	private final static int EXPIRY_MILLISECONDS = 6000;
	private final static SerializationType DEFAULT_SERIALIZATION = SerializationType.JAVA;

	@Autowired
	private Cache memcached;

	@Override
	public String lock(ApiType apiType, String identification) {
		String key = KeyMaker.getDupExePreventionKey(apiType, identification);

		try {
			if (isDupExecution(key)) {
				throw DuplicateExecutionException.of("중복실행 불가. api : %s, id : %s", apiType.getApiKey(), identification);
			}

			memcached.add(key, EXPIRY_MILLISECONDS, true, DEFAULT_SERIALIZATION);
		} catch (DuplicateExecutionException e) {
			throw e;
		} catch (Exception e) {
			throw new RuntimeException(e);
		}

		return key;
	}

	@Override
	public String unlock(String lock) {
		try {
			memcached.delete(lock);
		} catch (Exception e) {
			throw new RuntimeException(e);
		}

		return lock;
	}

	private boolean isDupExecution(String key) throws Exception {
		Optional<Boolean> optional = Optional.ofNullable(memcached.get(key, DEFAULT_SERIALIZATION));

		return optional.orElse(false);
	}
}
```

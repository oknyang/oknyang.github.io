---
title: couchbase 장애
date: 2020-11-01
---

### 장애 원인
1테라 가량의 데이터에 대한 인덱스 생성을 진행하던 중,  
couchbase 특정 노드의 인덱스 서비스가 bootstrap 상태로 빠짐.  
bootstrap 상태가 되면 n1ql 사용 불가.  
실제 중요한 데이터는 8000로우짜리 작은 버켓이었는데, 인덱스 서비스 먹통으로 이 데이터 조회를 못하는 상황이 발생함.  
이때문에 연동쪽 티켓 발급에 문제가 생김.  

### 해결 과정
#### 해결책 고려
카우치베이스 재시작 -> 실패.  
중요 데이터 rdb 이관 -> 바로 이관하기 어려움. (하필 자리이동한다고 사내 모든 데스크탑 전원 off 상태).  
문제가 된 노드 말고 다른 노드에 이름 바꿔 인덱스 생성 -> 새로 생성된 인덱스도 bootstrap 상태로 빠지면서 실패.  
다른 카우치베이스 클러스터로 데이터 이관 -> 성공

#### 다른 노드에 인덱스 생성
카우치베이스 1번 노드의 인덱스 서비스가 비정상인 상황이었고, 보통 다른 노드에 인덱스명을 달리해서 동일하게 생성 가능했기에, 일단 1번을 제외한 다른 노드에 인덱스 생성을 시도함.  
이때, 우려되었던 것이, primary 인덱스가 모두 1번 노드에 있었고, primary 인덱스도 bootstrap 상태였던지라, 다른 노드에 인덱스를 생성할 때 영향이 가지 않을까 싶었지만, 일단 시도해봄.  
새로 생성한 인덱스 역시 bootstrap 상태로 빠져버림.

#### xdcr 이용한 데이터 복제
카우치베이스가 거지같은데, 몇가지 장점이 있음. 그 중 하나가 xdcr이라는 클러스터간 데이터 복제기능.  
문제가 된 카우치베이스 클러스터에서, 다른 데이터는 다 버리고, 8000로우짜리 중요 데이터만 xdcr 기능을 이용해 다른 카우치베이스 클러스터로 이관함.  
이후 코드에서 클러스터 정보 변경하고, 무거운 데이터는 쌓이지 않도록 수정 배포해서 장애 처리 완료.
